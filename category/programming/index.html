<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>だからといって、このままでいいはずがない。 - Programming だからといって、このままでいいはずがない。</title>

    <link rel="stylesheet" href="/theme/css/main.css">
    <link rel="stylesheet" href="/theme/css/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <div><img src="" class="grv-img"/></div>
        <div class="title"><a href="/">だからといって、このままでいいはずがない。 </a></div>
        <div class="sub-title"></div>

<p>
    <div class="view"><a href="/pages/about-me.html">About Me</a></div>
  <div class="view"><a href="/archives.html">Archives</a></div>
</p>

<!-- Social links -->
<div class="social">
<h4>Follow Me</h4>
<ul>
    <li><a href="#">You can add links in your config file</a></li>
    <li><a href="#">Another social link</a></li>
</ul>
</div>

      </header>
      <section>
      <div class="front-title"><a href="/posts/2013/12/24/face-detection-from-movie/">動画に対する顔検出</a></div>
<p>
<small>
<abbr class="published" title="2013-12-24T22:32:00">
  火 24 12月 2013
</abbr> | 
 -- (<a href="/posts/2013/12/24/face-detection-from-movie/" rel="bookmark">permalink</a>)
</small>
</p>      <p>(この投稿はQiitaの<a href="http://qiita.com/advent-calendar/2013/ios-2">iOS Second Stage Advent Calendar
2013</a>の25日目の記事です)</p>
<p>もはや非常に一般的となった、CIDetectorによる顔検出。  </p>
<p>ただ、よく見るサンプルはほとんどカメラの入力に対するリアルタイム検出ばかりだったので、</p>
<p>試しに動画に対して顔を検出するサンプルを作成してみた。</p>
<p><a href="https://github.com/yuseinishiyama/VideoFaceDetection">https://github.com/yuseinishiyama/VideoFaceDetection</a></p>
<p>CIDetectorとAVAssetReaderを組み合わせるだけで簡単にできる。</p>
<p>VFDVideoFaceDetector.h</p>
<div class="highlight"><pre><span class="cp">#import &lt;Foundation/Foundation.h&gt;</span>

<span class="k">typedef</span> <span class="nf">void</span><span class="p">(</span><span class="o">^</span><span class="n">VFDVideoReaderCompletionHandler</span><span class="p">)(</span><span class="n">NSArray</span> <span class="o">*</span><span class="n">allFeatures</span><span class="p">);</span>

<span class="k">@interface</span> <span class="nc">VFDVideoFaceDetector</span> : <span class="nc">NSObject</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">readFromURL:</span><span class="p">(</span><span class="n">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="nv">targetURL</span>
<span class="nl">complitionHandler:</span><span class="p">(</span><span class="n">VFDVideoReaderCompletionHandler</span><span class="p">)</span><span class="nv">completionHandler</span><span class="p">;</span>
<span class="k">@end</span>
</pre></div>


<p>VFDVideoFaceDetector.m</p>
<div class="highlight"><pre><span class="cp">#import &quot;VFDVideoFaceDetector.h&quot;</span>
<span class="cp">#import &lt;AVFoundation/AVFoundation.h ...</span></pre></div> 
      <div class="read-more"><a href="/posts/2013/12/24/face-detection-from-movie/">read more...</a></div>
      <hr />
      <div class="front-title"><a href="/posts/2013/11/13/tech-hills7/">第7回テックヒルズにいってきました。</a></div>
<p>
<small>
<abbr class="published" title="2013-11-13T02:27:00">
  水 13 11月 2013
</abbr> | 
 -- (<a href="/posts/2013/11/13/tech-hills7/" rel="bookmark">permalink</a>)
</small>
</p>      <p>Unityを触ったり、簡単なシェーダー書いたりしてるうちに描画処理への関心が高まってきた。ゲームとかグラフィックスの分野は、一定以上のものを作るために比較的コアな知識がいる一方で、結果がキャッチーで分かりやすい。ゲームにはあまり興味がない私だが、ゲームエンジンブームである。先日、<a href="http://d.hatena.ne.jp/hdk_embedded/20131106/1383681073">「Playgroundハッカソン」</a>に参加してからというもの、ますます興味が湧いてきている。</p>
<p>そんなわけで、「Game
Engines」がテーマの<a href="http://atnd.org/events/44622" title="第7回テックヒルズ">第7回テックヒルズ</a>に行ってきた。</p>
<p>以下が公開されているスライドへのリンクだ(一部、公開が確認できていないものもある)。</p>
<ol>
<li><a href="http://www.slideshare.net/keigoando/unity2-dnew-gui" title="Unity2DとnewGUIについて">「Unity2DとnewGUIについて」</a>安藤
    圭吾さん(ユニティ・テクノロジーズ・ジャパン)</li>
<li><a href="http://www.slideshare.net/KatsutoshiMakino/aiming" title="Aiming開発ゲームの裏側">「Aiming開発ゲームの裏側」</a>牧野 克俊さん(Aiming)</li>
<li><a href="http://www.slideshare.net/doraemonsss/cocos2d-x-28145813?ref=http://sssslide.com/www.slideshare.net/doraemonsss/cocos2d-x-28145813" title="cocos2d-xおよび開発ツールについて">「cocos2d-xおよび開発ツールについて」</a>清水 友晶さん(TKS2)</li>
<li>「 enchant.jsの野望 9分コーディングライブ」 清水
    亮さん(ユビキタスエンターテインメント)</li>
<li><a href="http://www.slideshare.net/KeiNakazawa/131112-tech-hills-playground-introduction" title="Introduction">「イントロダクション」</a>
    &amp;<a href="http://www.slideshare.net/RomainPiquois/playground-28101668" title="Playground内の描画仕組み">「Playgroundの描画仕組み」</a>＆<a href="http://www.slideshare.net/KeiNakazawa/playgroundandroid-pfandroid" title="&quot;Playground&quot;とAndroid">「マルチPF対応ゲームエンジン内のAndroid対応」</a>ロマン・ピコアさん(KLab)
    ・中澤 慧さん(KLab)</li>
<li>「次世代ゲームエンジンの比較 ...</li></ol> 
      <div class="read-more"><a href="/posts/2013/11/13/tech-hills7/">read more...</a></div>
      <hr />
      <div class="front-title"><a href="/posts/2013/10/09/change-theme/">テーマを変更しました。</a></div>
<p>
<small>
<abbr class="published" title="2013-10-09T02:33:00">
  水 09 10月 2013
</abbr> | 
 -- (<a href="/posts/2013/10/09/change-theme/" rel="bookmark">permalink</a>)
</small>
</p>      <p>開発者のWordpressサイトがデフォルトのテーマだというのもなんとなく恥ずかしいので、テーマを作成してみた。とはいえ、Webの開発経験は全然ないので結構苦戦した。未だにあちこち粗が目立つ。しかし、「そのうち全部直して適応〜」とかいってると、一生デフォルトのを使い続けそうなので、先に本番環境に適応してから少しずつ修正することにした。</p>
<p>レスポンシブデザインとかそういうことも考えだすと、自作するのを辞めたい衝動に駆られてしまうが・・・。</p> 
      <div class="read-more"><a href="/posts/2013/10/09/change-theme/">read more...</a></div>
      <hr />
      <div class="front-title"><a href="/posts/2013/09/16/get-latest-app-version-of-ios-application/">iOSでアプリの最新バージョンを取得する方法。</a></div>
<p>
<small>
<abbr class="published" title="2013-09-16T21:50:00">
  月 16 9月 2013
</abbr> | 
 -- (<a href="/posts/2013/09/16/get-latest-app-version-of-ios-application/" rel="bookmark">permalink</a>)
</small>
</p>      <p>開発者であれば、ユーザーには自分の開発したアプリの最新版を使ってほしいと思うだろう。また、ユーザーのアプリバージョンにばらつきがないことは、ビジネス面のメリットも大きい。仕事として開発を行っている人であれば、「アプリのアップデートが行われた場合に通知する機能」の実装を要求されたことは多々あるだろう。</p>
<p>そこで今回は、</p>
<p>アプリの最新版を取得し、ユーザーが利用しているアプリが最新版より古ければ通知する機能</p>
<p>の実装方法を紹介する。</p>
<p>さて、まず考えなくてはいけないのは、どこからアプリの最新版を取得するか、ということである。これにはおおまかに言って、2通りの方法がある。「1.自前のサーバを利用する方法」、と「2.AppleのAPIを利用する方法」の2つだ。どちらが適切な方法であるか比較するために、それぞれのメリット、デメリットを挙げてみた。</p>
<p>1.自前のサーバを利用する方法</p>
<p>メリット</p>
<ul>
<li>テストが容易。</li>
<li>更新のタイミングを自由に決めることができる。</li>
<li>取得先が勝手に変更されることがない。</li>
</ul>
<p>デメリット</p>
<ul>
<li>運用者が必要。</li>
<li>運用ミスが発生する可能性がある。</li>
</ul>
<p>2.AppleのAPIを利用する方法。</p>
<p>メリット</p>
<ul>
<li>自分で運用しなくて良い。</li>
<li>運用ミスが発生しない。</li>
</ul>
<p>デメリット</p>
<ul>
<li>テストが行えない。</li>
<li>APIが変更された場合、機能が無効になる。</li>
<li>APIから取得できるバージョンと、ストアへ反映されているバージョンとの間にタイムラグがあったりなどした場合、その間はどうすることもできない。</li>
</ul>
<p>結論から言うと、「AppleのAPIを使ったほうが楽だが ...</p> 
      <div class="read-more"><a href="/posts/2013/09/16/get-latest-app-version-of-ios-application/">read more...</a></div>
      <hr />
      <div class="front-title"><a href="/posts/2013/09/07/addition-to-required-device-capability/">UnityでiOS向けのビルド時に、RequiredDeviceCapabilityを追加する方法。</a></div>
<p>
<small>
<abbr class="published" title="2013-09-07T21:06:00">
  土 07 9月 2013
</abbr> | 
 -- (<a href="/posts/2013/09/07/addition-to-required-device-capability/" rel="bookmark">permalink</a>)
</small>
</p>      <p><a href="https://developer.apple.com/library/ios/documentation/general/Reference/InfoPlistKeyReference/Articles/iPhoneOSKeys.html">RequiredDeviceCapability</a>を正しく設定していないと、Appleにリジェクトされてしまうことは、広く知られている。</p>
<p>例えば、アプリに静止画を撮影する機能がある場合、このRequiredDeviceCapabilityに「still-camera」を追加してやらないといけない。</p>
<p>RequiredDeviceCapabilityは正しく設定されていなくても、ビルドに失敗しないし、Validationも通過する。だからこそ、リジェクトされてから気づくわけで、こういう作業は特に自動化するメリットが大きいだろう。</p>
<p>そこで、PostProcessBuildPlayerを利用し、Unityからのビルド時にInfo.plistを書き換えて、RequiredDeviceCapabilityを編集する関数を作成してみた。</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">process_plist</span><span class="p">(</span><span class="n">plist_filepath</span><span class="p">):</span>
  <span class="n">pl</span> <span class="o">=</span> <span class="n">plistlib</span><span class="o">.</span><span class="n">readPlist</span><span class="p">(</span><span class="n">plist_filepath</span><span class="p">)</span>
  <span class="n">new_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;still-camera&quot;</span><span class="p">}</span>
  <span class="k">if</span> <span class="s">&quot;UIRequiredDeviceCapabilities&quot;</span> <span class="ow">in</span> <span class="n">pl</span><span class="p">:</span>
    <span class="n">pl</span><span class="p">[</span><span class="s">&quot;UIRequiredDeviceCapabilities&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_settings</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">pl</span><span class="p">[</span><span class="s">&quot;UIRequiredDeviceCapabilities&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_settings</span><span class="p">]</span>
  <span class="n">plistlib</span><span class="o">.</span><span class="n">writePlist</span><span class="p">(</span><span class="n">pl</span><span class="p">,</span> <span class="n">plist_filepath</span><span class="p">)</span>
</pre></div>


<p>Info.plistのパスを与えてやると、Info.plistに「still-camera ...</p> 
      <div class="read-more"><a href="/posts/2013/09/07/addition-to-required-device-capability/">read more...</a></div>
      <hr />
      <div class="front-title"><a href="/posts/2013/09/06/screenshot-with-unity-ios/">Unityでスクリーンショットを撮影し、iPhoneのカメラロールに保存する方法。</a></div>
<p>
<small>
<abbr class="published" title="2013-09-06T02:55:00">
  金 06 9月 2013
</abbr> | 
 -- (<a href="/posts/2013/09/06/screenshot-with-unity-ios/" rel="bookmark">permalink</a>)
</small>
</p>      <p>Unityでスクリーンショットを撮るのは非常に簡単である。</p>
<p><a href="http://docs.unity3d.com/Documentation/ScriptReference/Application.CaptureScreenshot.html">Application.CaptureScreenshot</a>という関数が用意されているからだ。</p>
<p>だが、この方法ではアプリのデータ領域に画像が保存されるだけなので、ユーザーが、その画像を閲覧できるようにはならない。アプリ内で画像を管理できるようにしてもいいかもしれないが、スクリーンショットを確認したいだけなのであれば、そこまでする必要はないだろう。</p>
<p>そこで今回は、UnityからiOSのカメラロールにアクセスする方法を紹介する。</p>
<p>``` {.lang:objc .decode:true}</p>
<h1>import <Foundation/Foundation.h></h1>
<h1>import <AssetsLibrary/AssetsLibrary.h></h1>
<h1>import <AVFoundation/AVFoundation.h></h1>
<p>/<em> 
 スクリーンショット撮影時に利用するネイティブコード。
 </em>/</p>
<p>// 指定したパスの画像をカメラロールに保存する。
extern "C" void _WriteImageToAlbum (const char<em> path)
{
    UIImage </em>image = [UIImage imageWithContentsOfFile:[NSString stringWithUTF8String:path]];
    ALAssetsLibrary <em>library = [[[ALAssetsLibrary alloc] init] autorelease];
    NSMutableDictionary </em>metadata = [[[NSMutableDictionary alloc] init] autorelease];
    [library writeImageToSavedPhotosAlbum ...</p> 
      <div class="read-more"><a href="/posts/2013/09/06/screenshot-with-unity-ios/">read more...</a></div>
      <hr />
      <div class="front-title"><a href="/posts/2013/08/31/setup-raspberrypi/">Raspberry Piのセットアップ(NOOBS)。</a></div>
<p>
<small>
<abbr class="published" title="2013-08-31T21:08:00">
  土 31 8月 2013
</abbr> | 
 -- (<a href="/posts/2013/08/31/setup-raspberrypi/" rel="bookmark">permalink</a>)
</small>
</p>      <p>購入してからしばらく放置していたRaspberry Piをセットアップしてみる。</p>
<p>今のところRaspberry
Piでやりたいことはないから、セットアップするに足る目的もないけどなぁ、などと思いつつ作業を開始する。すると、どうしたことか全然上手くいかないので、セットアップすることが目的になって、Raspberry
Piが起動した時には、なんとも言えない達成感が・・・。セットアップとは得てして、このような性質を持った作業である。</p>
<p>さて、私の「セットアップ観」など何の役にも立たないので、私がセットアップの際に困った事を展開したい。</p>
<p>まずインストールするOSをダウンロードするために、下記サイトを見る。</p>
<p><a href="http://www.raspberrypi.org/downloads">http://www.raspberrypi.org/downloads</a></p>
<p>「初心者はNOOBSを利用してOSをインストールするのが、おすすめ」ということなので、それに従う(ちなみにnoobは「新参者」という意味らしい)。「俺は利口だから中級者以上の扱いで頼むぜ」という感じで臨んで、マニュアルで色々やろうとしたら散々な結果になった、などということはぜひとも避けたい。</p>
<p>さて、Transcendの8GB(Class10)のSDカードをフォーマットし、そこにNOOBSのファイルを突っ込み、Raspberry
Piを起動した。</p>
<p>しかし、画面に何も表示されない。よくみると「ACT」のLEDが消灯しているので、それを手がかりに調べてみる ...</p> 
      <div class="read-more"><a href="/posts/2013/08/31/setup-raspberrypi/">read more...</a></div>
      <hr />
      <div class="front-title"><a href="/posts/2013/07/01/calculate-luminance/">輝度の計算</a></div>
<p>
<small>
<abbr class="published" title="2013-07-01T00:50:00">
  月 01 7月 2013
</abbr> | 
 -- (<a href="/posts/2013/07/01/calculate-luminance/" rel="bookmark">permalink</a>)
</small>
</p>      <p>シェーダーでは、よくこんなコードを見かける。</p>
<p>``` {.lang:c .decode:true title="Luminance"}
const mediump vec3 Perception = vec3(0.299, 0.587, 0.114);</p>
<p>void main(void)
{
    mediump vec3 color = texture2D(Sampler, TextureCoord).xyz;
    mediump float luminance = dot(Perception, color);
    gl_FragColor = (luminance &gt; Threshold) ? vec4(color, 1) : vec4(0);
}
```</p>
<p>輝度がThresholdを上回れば、テクスチャの色を使い、そうでなければ黒にするということは分かる。それにしても、luminanceを取得するときにテクスチャの色と内積をとっているPerceptionとはなんだろうか。謎めいた値がハードコードされている。</p>
<p>どうも人間の光受容体の特性を考慮するための値らしい ...</p> 
      <div class="read-more"><a href="/posts/2013/07/01/calculate-luminance/">read more...</a></div>
      <hr />
      <div class="front-title"><a href="/posts/2013/06/13/simultaneous-video-playing-in-ios/">iPhoneでの同時動画再生数の上限について</a></div>
<p>
<small>
<abbr class="published" title="2013-06-13T00:15:00">
  木 13 6月 2013
</abbr> | 
 -- (<a href="/posts/2013/06/13/simultaneous-video-playing-in-ios/" rel="bookmark">permalink</a>)
</small>
</p>      <p>現在動画編集アプリを作っている。<br />
動画にエフェクトとかBGMとかなんやらの設定をしていくわけだが、  </p>
<p>画面上部にプレビュー画面を持ち、その下に編集用のOutletがいくつか存在するような見た目のViewControllerがNavigationControllerでいくつか続いていくというような作りだ。</p>
<p>ここで奇妙な問題が発生した。<br />
MPMoviePlayerControllerを使用して、動画を再生しようとしたところ</p>
<p>``` {.lang:objc .decode:true}
Error Domain=AVFoundationErrorDomain Code=-11839 "Cannot Decode"</p>
<div class="highlight"><pre><span class="err">こんなエラーがでた。デコードできない？動画の形式が悪いのだろうか？</span>  

<span class="err">だが、試しにその</span><span class="n">ViewController</span><span class="err">だけにして実行してみたところ問題なく再生できた。</span>  
<span class="err">ということは、特定のコンテキストにおいてのみデコードが失敗するわけだ。</span>

<span class="p">[</span><span class="err">先日の記事</span><span class="p">][]</span><span class="err">にもある通り、いざ実装を始めると全く予期しないところで躓くことが多々ある。</span>  

<span class="err">特にこういうロジックの問題でない箇所は原因の特定が難しく、心が折れそうになる。</span>

<span class="err">とにかくググるしかないので、上記のログをそのまま検索バーに貼り付けた。</span>  
<span class="err">すると同じ様な現象で困っている人を発見することが出来た。</span>

<span class="p">[</span><span class="n">http</span><span class="o">:</span><span class="c1">//stackoverflow.com/questions/8608570/avplayeritem-fails-with-avstatusfailed-and-error-code-cannot-decode][]</span>

<span class="o">&gt;</span> <span class="n">There</span> <span class="n">is</span> <span class="n">a</span> <span class="n">limit</span> <span class="n">on</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">concurrent ...</span></pre></div> 
      <div class="read-more"><a href="/posts/2013/06/13/simultaneous-video-playing-in-ios/">read more...</a></div>
      <hr />
      <div class="front-title"><a href="/posts/2013/06/02/constant-string-in-objectivec/">Objective-Cで文字列定数</a></div>
<p>
<small>
<abbr class="published" title="2013-06-02T21:54:00">
  日 02 6月 2013
</abbr> | 
 -- (<a href="/posts/2013/06/02/constant-string-in-objectivec/" rel="bookmark">permalink</a>)
</small>
</p>      <p>Objective-Cで文字列定数の宣言をする方法について考えてみた。<br />
最も手っ取り早いのは当然マクロだろう。</p>
<p>``` {.lang:objc .decode:true title="SomeClass.m"}</p>
<h1>define CONST_STR @"Const Str"</h1>
<div class="highlight"><pre><span class="err">だが、当然二重定義の問題があるので好ましいとは言えない。</span>  
<span class="err">より好ましいのは以下の方法だろう。</span>

<span class="err">```</span> <span class="p">{.</span><span class="n">lang</span><span class="o">:</span><span class="n">objc</span> <span class="p">.</span><span class="n">decode</span><span class="o">:</span><span class="nb">true</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;SomeClass.m&quot;</span><span class="p">}</span>
<span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span> <span class="k">const</span> <span class="n">kConstStr</span> <span class="o">=</span> <span class="s">@&quot;Const Str&quot;</span><span class="p">;</span>
</pre></div>


<p>constの位置に注意。<br />
文字列に対するポインタにconstを指定している。  </p>
<p>（ちなみにObective-Cではメンバ変数のプレフィックは「_」が完全に推奨されている一方で、定数にこうしたハンガリアン記法を使うかどうか迷いどころだが、たいがいのフレームワークでは定数はこの形で書かれているし、実際しっくりくる。）</p>
<p>さてこの定数を外部に公開したいとする。<br />
ここでこんな風にやってしまうと間違いだ。</p>
<p>``` {.lang:objc .decode:true title="SomeClass.h"}
static NSString * const kConstStr ...</p> 
      <div class="read-more"><a href="/posts/2013/06/02/constant-string-in-objectivec/">read more...</a></div>
      <hr />

      </section>
      <footer>
        <p><small>&copy; だからといって、このままでいいはずがない。 &mdash; Theme based on Sundown by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <!-- Scale fix -->
    <script>
      var metas = document.getElementsByTagName('meta');
      var i;
      
      if (navigator.userAgent.match(/iPhone/i)) {
        for (i=0; i<metas.length; i++) {
          if (metas[i].name == "viewport") {
            metas[i].content = "width=device-width, minimum-scale=1.0, maximum-scale=1.0";
          }
        }
      
        document.addEventListener("gesturestart", gestureStart, false);
      }

      function gestureStart() {
        for (i=0; i<metas.length; i++) {
          if (metas[i].name == "viewport") {
            metas[i].content = "width=device-width, minimum-scale=0.25, maximum-scale=1.6";
          }
        }
      }
    </script>
  </body>
</html>